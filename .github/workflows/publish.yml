name: Publish to npm

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build all packages
        run: pnpm turbo run build

      - name: Typecheck all packages
        run: pnpm turbo run typecheck

      - name: Run smoke tests
        run: node tests/smoke.mjs

  publish:
    needs: ci
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm turbo run build

      - name: Publish packages (skip if version already exists)
        run: |
          PACKAGES=(
            "packages/browsecraft-bidi"
            "packages/browsecraft-ai"
            "packages/browsecraft-runner"
            "packages/browsecraft-bdd"
            "packages/browsecraft"
          )

          for pkg in "${PACKAGES[@]}"; do
            NAME=$(node -p "require('./$pkg/package.json').name")
            LOCAL_VERSION=$(node -p "require('./$pkg/package.json').version")
            REMOTE_VERSION=$(npm view "$NAME" version 2>/dev/null || echo "0.0.0")

            if [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
              echo "Publishing $NAME@$LOCAL_VERSION (remote: $REMOTE_VERSION)"
              cd "$pkg"
              pnpm publish --access public --no-git-checks --provenance
              cd "$GITHUB_WORKSPACE"
            else
              echo "Skipping $NAME@$LOCAL_VERSION (already published)"
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        id: notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Get the previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -A1 "^${TAG}$" | tail -1)
          if [ "$PREV_TAG" = "$TAG" ] || [ -z "$PREV_TAG" ]; then
            # First release â€” use all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" "${PREV_TAG}..${TAG}")
          fi
          {
            echo "NOTES<<EOF"
            echo "## What's Changed"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "## Packages"
            echo ""
            echo "| Package | Version |"
            echo "|---------|---------|"
            echo "| [browsecraft](https://www.npmjs.com/package/browsecraft) | ${{ steps.version.outputs.VERSION }} |"
            echo "| [browsecraft-bidi](https://www.npmjs.com/package/browsecraft-bidi) | ${{ steps.version.outputs.VERSION }} |"
            echo "| [browsecraft-ai](https://www.npmjs.com/package/browsecraft-ai) | ${{ steps.version.outputs.VERSION }} |"
            echo "| [browsecraft-bdd](https://www.npmjs.com/package/browsecraft-bdd) | ${{ steps.version.outputs.VERSION }} |"
            echo "| [browsecraft-runner](https://www.npmjs.com/package/browsecraft-runner) | ${{ steps.version.outputs.VERSION }} |"
            echo ""
            echo "Install: \`npm install browsecraft@${{ steps.version.outputs.VERSION }}\`"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.VERSION }}
          body: ${{ steps.notes.outputs.NOTES }}
          generate_release_notes: false
